/*
 * Copyright (C) 2015-2019 akha, a.k.a. Alexander Kharitonov
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
 
// Yakhont preprocessor (generates the "full" flavor's sources "on the fly")

import groovy.transform.Field

@Field final boolean addDebugActivities               = true  // auto generate additional debug Activities
@Field final boolean addDebugFragments                = true  // auto generate additional debug Fragments

@Field final String  corePath                         = 'src/main/java/akha/yakhont'
@Field final String  corePathDebug                    = corePath + '/debug'

@Field final String  fullPath                         = 'src/full/java/akha/yakhont'
@Field final String  fullPathDebug                    = fullPath + '/debug'

@Field final String  preprocessorAddToGenerated       = '//YakhontPreprocessor:addToGenerated'
@Field final String  preprocessorRemoveInFlavor       = '//YakhontPreprocessor:removeInFlavor'
@Field final String  preprocessorRemoveInGenerated    = '//YakhontPreprocessor:removeInGenerated'

@Field final String  preprocessorDocRemoveInGenerated = '@yakhont.preprocessor.remove.in.generated'

@Field final String  fragmentActivity                 = 'androidx.fragment.app.FragmentActivity'

task preprocessor {
    doLast {
        // based on search and replace
        // but if something will go wrong - it'll just not compile (or throw GradleException)

        println('Yakhont: preprocess sources (for the "full" flavor)...')

        clearTmpSources()

        if (addDebugActivities) { generateActivities() }
        if (addDebugFragments ) { generateFragments () }

        completePreprocessor()
    }
}

preBuild.dependsOn preprocessor

gradle.buildFinished { buildResult -> clearTmpSources() }

////////////////////////////////////////////////////////////////////////////////////////////////////

// if you need more lifecycle debug versions of Activities and Fragments (including 3rd party ones) - 
// please don't hesitate to add them to the arrays below
// you will find generated debug classes in the 'debug' package with prefix 'Base'
    
// also, you can remove debug Activities and Fragments which is not needed

def generateActivities() {

    String[] debugActivityClasses = [
        'android.accounts.AccountAuthenticatorActivity'                                     ,               
        'android.app.AliasActivity'                                                         ,
        'android.app.ExpandableListActivity'                                                ,                     
        'android.app.LauncherActivity'                                                      ,                           
        'android.app.ListActivity'                                                          ,                               
        'android.app.NativeActivity'                                                        ,                             
        'android.preference.PreferenceActivity'
    ]

    String[] debugSupportActivityClasses = [    // FragmentActivity is a special case
        'androidx.appcompat.app.AppCompatActivity'
    ]

    prepareTemplates(false, true)
    addActivities(fullPathDebug, false, debugActivityClasses       )

    delete fullPathDebug + '/BaseActivity.java'

    prepareTemplates(true, true)
    addActivities(fullPathDebug,  true, debugSupportActivityClasses)
}

def generateFragments() {

    String[] debugFragmentClasses = [
        'androidx.fragment.app.ListFragment'                                                ,
        'androidx.leanback.app.BrandedSupportFragment'                                      ,
        'androidx.leanback.app.BrowseSupportFragment'                                       ,
        'androidx.leanback.app.DetailsSupportFragment'                                      ,
        'androidx.leanback.app.ErrorSupportFragment'                                        ,
        'androidx.leanback.app.GuidedStepSupportFragment'                                   ,
        'androidx.leanback.app.HeadersSupportFragment'                                      ,
        'androidx.leanback.app.RowsSupportFragment'                                         ,
        'androidx.leanback.app.SearchSupportFragment'                                       ,
        'androidx.leanback.app.VerticalGridSupportFragment'                                 ,
        'androidx.leanback.preference.LeanbackListPreferenceDialogFragment'                 ,
        'androidx.leanback.preference.LeanbackPreferenceDialogFragment'                     ,
        'androidx.mediarouter.app.MediaRouteDiscoveryFragment'
    ]
    
    String[] debugDialogFragmentClasses = [
        'androidx.appcompat.app.AppCompatDialogFragment'                                    ,
        'androidx.mediarouter.app.MediaRouteChooserDialogFragment'                          ,
        'androidx.mediarouter.app.MediaRouteControllerDialogFragment'                       ,
        'androidx.preference.EditTextPreferenceDialogFragmentCompat'                        ,
        'androidx.preference.ListPreferenceDialogFragmentCompat'                            ,
        'androidx.preference.MultiSelectListPreferenceDialogFragmentCompat'
    ]

    prepareTemplates(true, false)
    addFragments(fullPathDebug, false, debugFragmentClasses      )
    addFragments(fullPathDebug,  true, debugDialogFragmentClasses)
}

def addActivities(String componentDir, boolean isSupport, String[] data) {
    data.each { addActivity(componentDir, getShortClassName(it), it, isSupport, false) }
}

def addActivity(String componentDir, String shortClassName, String fullClassName,
                boolean isSupport, boolean justRename) {
    addComponent(componentDir, 'BaseActivity', 'Base' + shortClassName, justRename,
        isSupport ? fragmentActivity: 'Activity', fullClassName)
}

def addFragments(String componentDir, boolean isDialog, String[] data) {
    data.each { addFragment(componentDir, getShortClassName(it), it, isDialog) }
}

def addFragment(String componentDir, String shortClassName, String fullClassName, boolean isDialog) {
    String add = isDialog ? 'Dialog': ''
    addComponent(componentDir, 'Base' + add + 'Fragment', 'Base' + shortClassName, false,
                 add + 'Fragment', fullClassName)
}

def addComponent(String componentDir, String oldName, String newName, boolean justRename,
                 String oldClass, String newClass) {
    String oldFileName = oldName + '.java'
    copy {
        from       (componentDir)
        include    (oldFileName )
        into       (componentDir)
        rename     { fileName -> fileName.replace(oldName,   newName)   }
        filter     { line     -> line    .replace(oldName,   newName)   }
        
        if (!justRename) {
            String shortClassName = getShortClassName(newClass)

            filter { line     -> //noinspection GroovyAssignabilityCheck
                replaceExtends(  line, oldClass, newClass, oldFileName) }

            filter { line     -> line.replace(preprocessorRemoveInFlavor, '') }

            filter { line     -> //noinspection GroovyAssignabilityCheck
                removeLine(line, preprocessorRemoveInGenerated,    shortClassName,  true,  true) }
            filter { line     -> //noinspection GroovyAssignabilityCheck
                removeLine(line, preprocessorDocRemoveInGenerated, shortClassName, false, false) }

            filter { line     -> //noinspection GroovyAssignabilityCheck
                addLine   (line, preprocessorAddToGenerated,       shortClassName,  true)        }
        }
    }
}

static def removeLine(String line, String target, String className, boolean endsWith,
                      boolean commentOut) {
    String newLine = line

    int idx       = line.lastIndexOf('-')
    int idxTarget = line.lastIndexOf(target)

    boolean endsCheck = line.trim().endsWith(target)
    if (idxTarget > 0 && idx > idxTarget) {
        endsCheck = line.substring(0, idx).trim().endsWith(target)
    }
    if (endsWith ? endsCheck: line.contains(target)) {
        boolean update = true
        if (idx > idxTarget && className.length() > 0) {
            List<String> names = Arrays.asList(line.substring(idx + 1).trim().split(','))
            update = names.contains(className)
        }
        if (update) {
            newLine = !commentOut ? null:
                    '// ' + (endsWith ? line.substring(0, idxTarget): line.replace(target, ''))
        }
        else if (idxTarget > 0) {
            newLine = line.substring(0, idxTarget)
        }
    }
    return newLine
}

static def addLine(String line, String target, String className, boolean removeExtraAddLines) {
    String newLine = line
    if (line.trim().startsWith(target)) {
        if (removeExtraAddLines) newLine = null

        int idx1 = line.indexOf('-')
        int idx2 = line.indexOf('-', idx1 + 1)

        List<String> names = Arrays.asList(line.substring(idx1 + 1, idx2).trim().split(','))
        if (names.contains(className)) {
            newLine = line.substring(idx2 + 1)
        }
    }
    return newLine
}

static def getShortClassName(String fullClassName) {
    return fullClassName.substring(fullClassName.lastIndexOf('.') + 1)
}

def prepareTemplates(boolean isSupport, boolean activities) {
    String filesMask = activities ? '**/BaseActivity.java': '**/*Fragment*'
    copy {
        from (fileTree(corePathDebug).include(filesMask))
        into (fullPathDebug)

        eachFile { copyDetails ->
            if (activities && isSupport) {
                filter { line ->    //noinspection GroovyAssignabilityCheck
                    replaceExtends(line, 'Activity', fragmentActivity, copyDetails.getName())
                }
                filter { line ->    //noinspection GroovyAssignabilityCheck
                    addLine(line, preprocessorAddToGenerated, 'FragmentActivity', false)
                }
            }
            filter { line ->        //noinspection GroovyAssignabilityCheck
                removeLine(line, preprocessorRemoveInFlavor, '', true, true)
            }
        }
    }
}

static def replaceExtends(String line, String oldString, String newString, String fileName) {
    String target = 'extends ' + oldString, newLine = line

    if (line.contains('extends') && line.contains(' ' + oldString)) {
        if (line.contains(target)) {
            newLine = line.replace(target, 'extends ' + newString)
        }
        else {
            throw new GradleException('not found \'' + target + '\' in ' + fileName)
        }
    }
    return newLine
}

def completePreprocessor() {
    if (addDebugActivities) {
        addActivity(fullPathDebug, 'FragmentActivity', null, true, true)
        delete fullPathDebug + '/BaseActivity.java'
    }
    if (addDebugFragments) {
        delete fullPathDebug + '/BaseFragment.java'
        delete fullPathDebug + '/BaseDialogFragment.java'
    }
}

def clearTmpSources() {
    ant.delete(includeEmptyDirs: 'true') {
        fileset(dir: file('src/full'), includes: '**/*', excludes: '**/AndroidManifest.xml')
    }
}
