#
#  Copyright (C) 2015-2019 akha, a.k.a. Alexander Kharitonov
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#       http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.

# Config line format - 3 tokens delimited by whitespaces:
#
#   <fully qualified class name>.method[(signature)]    <action>    'callback'
#     or
#   <fully qualified annotation name>.[_D | _R]         <action>    'callback'
#
# NOTE: please use single quotes; double quotes are only for literals inside callbacks
#   (see akha.yakhont.LogDebug below).
#
# The signature '()' means all methods with the name specified.
# The '_D' and '_R' means 'debug only' (or 'release only') builds.
#   NOTE: don't miss ending '.' for annotations.
#
# In case of several callbacks for the same method they are executed in the order declared here,
#   then annotation's callbacks (if any) - also in the declared order.
#
# The possible actions are:
#   before                           - insert 'callback' at the beginning of the method body
#   after                            - insert 'callback' at the end of the method body
#   finally                          - insert 'callback' in the 'finally' clause
#   <fully qualified exception name> - insert 'callback' in the 'catch' clause
#     (Note that the inserted code fragment must end with a 'throw' or 'return' statement.)
#
# The 'callback' may contain '$0' (means 'this'), '$$' (means the method arguments),
#   '$args' (the method arguments as an Object[]) and '$_' (means the method return value).
#
# For more info please visit the Javassist site: https://jboss-javassist.github.io/javassist/tutorial/tutorial2.html#before
#
# NOTE: callbacks compilation performs by Javassist library just before weaving.

# For implementation examples please refer to the javadoc for:
#   akha.yakhont.callback.BaseCallbacks
#   akha.yakhont.callback.BaseCallbacks.BaseActivityCallbacks
#   akha.yakhont.callback.BaseCallbacks.BaseFragmentCallbacks

# debug annotation: writes to log arguments and return value of annotated method (for debug builds only)
akha.yakhont.LogDebug._D  after  'akha.yakhont.CoreLogger.log("method: " + $proceed + ", args: " + java.util.Arrays.deepToString($args) + ", return value: " + akha.yakhont.CoreLogger.toString($_));'

# defines Yakhont configuration (for details please refer to Core.config(...) description in javadoc)
android.app.Application.onCreate()                 before  'akha.yakhont.Core.config(false, false, true);'
android.app.Activity.onCreate()                    before  'akha.yakhont.Core.config(false, false, true);'

# init Yakhont with default parameters; use Core.init(...) for explicit calls (if necessary)
android.app.Application.onCreate()                 after   'akha.yakhont.Core.initDefault($0);'
android.app.Activity.onCreate()                    before  'akha.yakhont.Core.initDefault($0);'

# base Fragment callbacks
androidx.fragment.app.Fragment.onCreate            after   'akha.yakhont.callback.lifecycle.BaseFragmentLifecycleProceed.onCreated          ($0, $$);'
androidx.fragment.app.Fragment.onStart             after   'akha.yakhont.callback.lifecycle.BaseFragmentLifecycleProceed.onStarted          ($0    );'
androidx.fragment.app.Fragment.onResume            after   'akha.yakhont.callback.lifecycle.BaseFragmentLifecycleProceed.onResumed          ($0    );'
androidx.fragment.app.Fragment.onPause             before  'akha.yakhont.callback.lifecycle.BaseFragmentLifecycleProceed.onPaused           ($0    );'
androidx.fragment.app.Fragment.onStop              before  'akha.yakhont.callback.lifecycle.BaseFragmentLifecycleProceed.onStopped          ($0    );'
androidx.fragment.app.Fragment.onDestroy           before  'akha.yakhont.callback.lifecycle.BaseFragmentLifecycleProceed.onDestroyed        ($0    );'
androidx.fragment.app.Fragment.onSaveInstanceState before  'akha.yakhont.callback.lifecycle.BaseFragmentLifecycleProceed.onSaveInstanceState($0, $$);'
androidx.fragment.app.Fragment.onActivityCreated   after   'akha.yakhont.callback.lifecycle.BaseFragmentLifecycleProceed.onActivityCreated  ($0, $$);'
# end of base Fragment callbacks

# pull-to-refresh
android.app.Activity.onResume                      after   'akha.yakhont.loader.wrapper.BaseLoaderWrapper.SwipeToRefreshWrapper.onPauseOrResume($0,  true);'
android.app.Activity.onPause                       before  'akha.yakhont.loader.wrapper.BaseLoaderWrapper.SwipeToRefreshWrapper.onPauseOrResume($0, false);'

# permissions requesting
android.app.Activity.onResume                      after   'akha.yakhont.CorePermissions.onResume($0);'
android.app.Activity.onRequestPermissionsResult    before  'akha.yakhont.CorePermissions.onRequestPermissionsResult($0, $$);'

# ATTENTION: the order of callbacks is important

# dynamic permissions handling
android.app.Activity.onActivityResult              before  'akha.yakhont.CorePermissions.onActivityResult($0, $$);'
# location access decision dialog
android.app.Activity.onActivityResult              before  'akha.yakhont.location.LocationCallbacks.onActivityResult($0, $$);'
# logger video recording
android.app.Activity.onActivityResult              before  'akha.yakhont.CoreLogger.onActivityResult($0, $$);'

# BaseViewModel loading check
android.app.Activity.onBackPressed                 before  '{if (akha.yakhont.loader.BaseViewModel.isLoadingForWeaver($0)) return;}'

# LiveData observers handling
android.app.Activity.onCreate()                    after   'akha.yakhont.loader.BaseViewModel.updateUiActivityForWeaver(false, $0);'
android.app.Activity.onDestroy                     before  'akha.yakhont.loader.BaseViewModel.updateUiActivityForWeaver(true , $0);'
androidx.fragment.app.Fragment.onCreate            after   'akha.yakhont.loader.BaseViewModel.updateUiFragmentForWeaver(false, $0);'

# Gestures handling
android.app.Activity.dispatchTouchEvent            before  'akha.yakhont.CoreLogger.handleGesture($0, $$);'

# prevents crashing on emulators without Google APIs (NullPointerException etc.)
android.app.Activity.startActivityForResult()  java.lang.RuntimeException  '{ akha.yakhont.location.LocationCallbacks.startActivityForResultExceptionHandler($0, $e); return; }'

# base callbacks support for API < 14 (ICE_CREAM_SANDWICH)
android.app.Activity.onCreate(Landroid/os/Bundle;)              after   'akha.yakhont.callback.lifecycle.BaseActivityLifecycleProceed.onCreated          ($0, $$);'
android.app.Activity.onStart                                    after   'akha.yakhont.callback.lifecycle.BaseActivityLifecycleProceed.onStarted          ($0    );'
android.app.Activity.onResume                                   after   'akha.yakhont.callback.lifecycle.BaseActivityLifecycleProceed.onResumed          ($0    );'
android.app.Activity.onPause                                    before  'akha.yakhont.callback.lifecycle.BaseActivityLifecycleProceed.onPaused           ($0    );'
android.app.Activity.onStop                                     before  'akha.yakhont.callback.lifecycle.BaseActivityLifecycleProceed.onStopped          ($0    );'
android.app.Activity.onDestroy                                  before  'akha.yakhont.callback.lifecycle.BaseActivityLifecycleProceed.onDestroyed        ($0    );'
android.app.Activity.onSaveInstanceState(Landroid/os/Bundle;)   before  'akha.yakhont.callback.lifecycle.BaseActivityLifecycleProceed.onSaveInstanceState($0, $$);'

android.app.Application.onConfigurationChanged                  after   'akha.yakhont.Core.onApplicationConfigurationChanged($$);'
# end of base callbacks support for API < 14
